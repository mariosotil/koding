#cloud-config
output : { all : '| tee -a /var/log/cloud-init-output.log' }
disable_root: false
disable_ec2_metadata: {{.DisableEC2MetaData}}
hostname: '{{.Hostname}}'

users:
  - default
  - name: '{{.Username}}'
    lock_passwd: True
    gecos: Koding
    groups: {{join .Groups ","}}
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash

write_files:
  # Create kite.key
  - path: /etc/kite/kite.key
    content: |
      {{.KiteKey}}

  # Create Koding metadata file.
  - path: /var/lib/koding/metadata.json
    permissions: '0644'
    content: |-
      {
          "konfig": {
              "endpoints": {
                  "koding": {
                      "public": "{{.KodingURL}}"
                  },
                  "tunnel": {
                      "public": "{{.TunnelURL}}"
                  }
              }
          }
      }

  # Create user script.
  - path: /var/lib/koding/user-data.sh
    permissions: '0755'
    encoding: b64
    content: |
      {{.UserData}}

runcmd:
  # Install & Configure klient
  - [touch, /var/log/upstart/klient.log, /var/log/cloud-init-output.log, /var/log/cloud-init.log, /var/lib/koding/user-data.sh]
  - [chmod, +r, /var/log/upstart/klient.log, /var/log/cloud-init-output.log, /var/log/cloud-init.log, /var/lib/koding/user-data.sh]
  - [wget, "{{.LatestKlientURL}}", --retry-connrefused, --tries, 5, -O, /tmp/latest-klient.deb]
  - [dpkg, -i, /tmp/latest-klient.deb]
  - [chown, -R, '{{.Username}}:{{.Username}}', /opt/kite/klient]
  - [sudo, -E, -u, "{{.Username}}", /opt/kite/klient/klient, -metadata-file, /var/lib/koding/metadata.json]
  - [service, klient, stop]
  - [sed, -i, 's/\.\/klient/sudo -E -u {{.Username}} \.\/klient/g', /etc/init/klient.conf]
  - [service, klient, start]
  - [rm, -f, /tmp/latest-klient.deb]
  - [/var/lib/koding/user-data.sh]

final_message: "_KD_DONE_"
